#!/bin/bash

# node name
base="base"
# application id
app="default-application"

if test $# -eq 0; then
	echo "[WARNING] no name is given for your new COHORTE NODE. By default it is named 'base'"
	echo "[WARNING] no id is given for node's application. By default it is named 'default-application'"
else 
	base="$1"
	if test $# -gt 1; then
		app="$2"		
	fi
fi

# create the node
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
FOLDER=$PWD
rm -rf $HOME/cohorte_tmp &> /dev/null
if test -e "$base"; then
	echo "[ERROR] another COHORTE NODE with the same name :$base: already exists!"
	exit
fi
mkdir $base &> /dev/null
unzip $DIR/templates/cohorte-${project.version}-base-distribution.zip -d $HOME/cohorte_tmp &> /dev/null
mv $HOME/cohorte_tmp/cohorte-${project.version}/base/* $FOLDER/$base/ &> /dev/null
rm -rf $HOME/cohorte_tmp &> /dev/null

# set the application id for this node
boot_common="
/* WARNING!: do not edit, this file is generated automatically by cohorte-create-node command. */
{
    \"import-files\" : [ \"boot-common.js\" ],
    \"properties\" : {
        \"herald.application.id\" : \"$app\"
    }
}
"
echo "$boot_common" > $FOLDER/$base/conf/boot-common.js

# creating template for application composition
autorun_conf="
{
	\"name\" : \"$app\",
	\"root\" : {
		\"name\" : \"${app}-composition\",
		\"components\" : [ 
			/* your components should be described here */
		]
	}
}
"
echo "$autorun_conf" > $FOLDER/$base/conf/autorun_conf.js

echo "[INFO] creating a node '$base' for the application '$app'..."